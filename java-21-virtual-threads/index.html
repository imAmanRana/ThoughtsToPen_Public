<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Virtual Threads (Java 21) ‚Äì Thoughts To Pen</title> <meta name="description" content="My thoughts on Computer Programming || Psychology || Personal Finances || &amp; much more..."> <meta name="keywords" content="programming, java"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://thoughtstopen.com/assets/img/logo.png"> <meta name="twitter:title" content="Virtual Threads (Java 21)"> <meta name="twitter:description" content="Virtual Threads introduced in Java 21"> <meta name="twitter:site" content="@imAmanRana"> <meta name="twitter:creator" content="@imAmanRana"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Virtual Threads (Java 21)"> <meta property="og:description" content="Virtual Threads introduced in Java 21"> <meta property="og:url" content="https://thoughtstopen.com/java-21-virtual-threads/"> <meta property="og:site_name" content="Thoughts To Pen"> <meta property="og:image" content="https://thoughtstopen.com/assets/img/logo.png"> <link rel="canonical" href="https://thoughtstopen.com/java-21-virtual-threads/"> <link href="https://thoughtstopen.com/feed.xml" type="application/atom+xml" rel="alternate" title="Thoughts To Pen Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://thoughtstopen.com/assets/css/main.css"> <!-- JS --> <script src="https://thoughtstopen.com/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://thoughtstopen.com/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://thoughtstopen.com/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://thoughtstopen.com/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://thoughtstopen.com/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://thoughtstopen.com/favicon.png"> <link rel="shortcut icon" href="https://thoughtstopen.com/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(https://thoughtstopen.com/assets/img/placeholder-big.jpg); }</style> <!-- Post Feature Image --> <script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://thoughtstopen.com/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://thoughtstopen.com/assets/img/logo.png" alt="Thoughts To Pen photo" class="author-photo"> <h4>Thoughts To Pen</h4> <p>My thoughts on Computer Programming || Psychology || Personal Finances || &amp; much more...</p> </li> <li><a href="https://thoughtstopen.com/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/imAmanRana" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://instagram.com/i.m.amanrana" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-instagram"></i> Instagram</a> </li> <li> <a href="http://github.com/imAmanRana" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://stackoverflow.com/users/3932093/imamanrana" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-stack-overflow"></i> StackOverflow</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://thoughtstopen.com/posts/">All Posts</a></li> <li><a href="https://thoughtstopen.com/tags/">All Tags</a></li> </ul> </li> <li><a href="https://thoughtstopen.com/projects/">Projects</a></li> <li><a href="https://thoughtstopen.com/portfolio/">Portfolio</a></li> <li><a href="https://thoughtstopen.com/about/">About</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Virtual Threads (Java 21)</h1> <h4>12 Oct 2023</h4> <a class="btn zoombtn" onclick="window.history.back()"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="virtual-threads">Virtual Threads</h1> <p><strong>NOTE</strong>: This is a preview feature <em>NOT</em> enabled by-default in JDK-21.</p> <p>Virtual Threads are introduced under <strong>Project Loom</strong> and are part of <a href="https://openjdk.org/jeps/436" target="_blank">JPE-436</a>.</p> <p>We all might have heard about Threads in Java. They are old, very old, since JDK 2 released in 1998. üï∞</p> <p>They did a very good job in concurrent processing. But we must admit, in this ever changing world of programming, they have few problems:</p> <ol> <li>Even though they were light weight processes, but the Threads were just a thin wrapper around the operating system threads (the OS Threads). It was costly to create them and having a number of Threads running concurrently was practically limited by the system‚Äôs hardware, since <strong>they are mapped 1:1 to the OS threads</strong>.</li> <li>With the advancements in the J2EE, every incoming request is handled by a thread (<em>thread-per-request</em> pattern). In the today‚Äôs world of microservices, a single request can fetch or update data on multiple systems. When the application waits for the response from other microservices, the current thread remains in the idle state.</li> <li>Also, with the advent of Reactive Programming, much of the request-response have gone asynchronous. Information is request by a separate thread and the response is accepted on a separate thread, it makes it very difficult to debug. üòÆ‚Äçüí®</li> </ol> <h3 id="virtual-threads-1">Virtual Threads</h3> <p>Virtual Threads are also instances of <em>java.lang.Thread</em>. They run their code on the underlying OS thread, but <strong>DON‚ÄôT block the OS thread for its entire execution</strong>. Multiple virtual threads can be associated to a single OS thread.</p> <p><img src="/assets/img/VirtualThreads.png" alt="Virtual Thread's hierarchical diagram " title="Hierarchy Diagram for Virtual Threads"></p> <p>We can create millions ($ 10^ 6 $) of virtual threads independent of our system hardware. Virtual Threads are managed by JVM, so the overhead of context-switching is avoided.</p> <p>Virtual Threads do not block OS threads while they are not running. They are best suited for asynchronous APIs for achieving high scalability and throughput.</p> <h2 id="differences-between-classic-threads-and-virtual-threads">Differences between Classic Threads and Virtual Threads</h2> <ul> <li>
<strong>Virtual Threads are daemon threads</strong>: Means JVM won‚Äôt wait for them to be completed when exiting.</li> <li>
<strong>Virtual Threads always have normal priority</strong>.</li> <li>
<strong>Virtual Threads are not active members of thread group.</strong>: Call to <em>Thread.getThreadGroup()</em> on a virtual thread gives a generic name ‚Äú<em>VirtualThreads</em>‚Äù.</li> <li>
<strong>Virtual Threads do not support <em>stop()</em>, <em>resume()</em> or <em>suspend()</em> methods</strong>.</li> </ul> <h2 id="execution-and-performance-comparison-of-classic-threads-and-virtual-threads">Execution and Performance Comparison of Classic Threads and Virtual Threads</h2> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.IntStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VirtualThreads</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">increment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
		<span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">};</span>

		<span class="c1">// Classic Threads</span>
		<span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span> <span class="o">{</span>
			<span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10_000</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">runnable</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Classic Threads Total Time Taken: %d milliseconds"</span><span class="o">,</span> <span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">));</span>

		<span class="c1">// Virtual Threads</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newVirtualThreadPerTaskExecutor</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10_000</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">runnable</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="n">endTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Virtual Threads Total Time Taken: %d milliseconds"</span><span class="o">,</span> <span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">));</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div> <p>Since its a preview feature, similar to <a href="/java-21-String-Templates/">String Templates</a>, they are NOT enabled by default. Run the above code as:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">--enable-preview</span> <span class="nt">--source</span> 21 VirtualThreads.java
</code></pre></div></div> <p>Output is:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Classic Threads Total Time Taken: 100798 milliseconds
Virtual Threads Total Time Taken: 1823 milliseconds
</code></pre></div></div> <p>This huge difference in the execution time is due to the fact that the Executor service have created around 10K Virtual Threads since they are very light weight and doesn‚Äôt require overhead of context switching as Classic threads do.</p> <p>I tried experimenting with the fixed pool size of Classic threads. Even when I increased its size to 10K via <code class="language-plaintext highlighter-rouge">Executors.newFixedThreadPool(10000)</code>, I still got better performance for Virtual Threads (~3x more faster).</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Classic Threads Total Time Taken: 3569 milliseconds
Virtual Threads Total Time Taken: 1366 milliseconds
</code></pre></div></div> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://thoughtstopen.com/tags/#programming" title="Pages tagged programming" class="tag"><span class="term">programming</span></a><a href="https://thoughtstopen.com/tags/#java" title="Pages tagged java" class="tag"><span class="term">java</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://thoughtstopen.com/java-21-virtual-threads/" target="_blank" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://thoughtstopen.com/java-21-virtual-threads/" target="_blank" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://api.whatsapp.com/send?text=https://thoughtstopen.com/java-21-virtual-threads/" target="_blank" title="Share on Whatsapp" class="tag"> <span class="term"><i class="fa fa-whatsapp"></i> Msg</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="https://thoughtstopen.com/assets/js/jquery-1.12.0.min.js"></script> <script src="https://thoughtstopen.com/assets/js/jquery.dlmenu.min.js"></script> <script src="https://thoughtstopen.com/assets/js/jquery.goup.min.js"></script> <script src="https://thoughtstopen.com/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://thoughtstopen.com/assets/js/jquery.fitvid.min.js"></script> <script src="https://thoughtstopen.com/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-KR4P1CKKT4"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-KR4P1CKKT4'); </script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
